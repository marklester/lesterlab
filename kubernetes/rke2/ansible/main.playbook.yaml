- name: common node setup
  hosts: helium.home
  vars_files:
  - secrets.yml
  become: yes  # Run as sudo
  tasks:
    - name: Install Nfs Common
      apt:
        name: nfs-common
        state: present
        update_cache: yes
    - name: Update Nfs Mount Configuration
      ansible.builtin.copy:
        dest: /etc/nfsmount.conf
        content: |
          [ NFSMount_Global_Options ]
          Defaultvers=4.1
    - name: update-sysctl-settings
      ansible.builtin.copy:
        dest: /etc/sysctl.d/local.conf
        content: |
          fs.inotify.max_user_watches = 1048576          
    - name: Reload all sysctl configuration using shell command
      ansible.builtin.shell: sysctl -p --system
    - name: ensure rancher config dir exists
      file:
        path: /etc/rancher/rke2
        recurse: true
        state: directory
    - name: generate-rke-config
      ansible.builtin.copy:
        dest: /etc/rancher/rke2/config.yaml
        content: |
          token: {{ main_rke2_token }}
          server: 'https://rke2.home:9345'
          tls-san:
            - rke2.home
          ingress-controller: none
          etcd-expose-metrics: true
          kube-controller-manager-arg:
            - 'bind-address=0.0.0.0'
          kube-scheduler-arg:
            - 'bind-address=0.0.0.0' 
          kubelet-arg:
            - 'allowed-unsafe-sysctls=net.ipv4.conf.all.src_valid_mark,net.ipv6.conf.all.disable_ipv6'
    - name: Enable and start a rke2 server
      ansible.builtin.service:
        name: rke2-server
        state: restarted
        enabled: yes